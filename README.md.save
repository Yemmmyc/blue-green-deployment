ğŸ¯ HNG DevOps Intern Stage 2 â€“ Blue/Green Deployment with Nginx

Author: Yemisi Okunrounmu (DevOps Intern)
Project: Blue/Green Node.js Service Behind Nginx with Auto-Failover & Manual Toggle
Stack: Docker, Docker Compose, Nginx

ğŸŒŸ Overview

This project demonstrates a Blue/Green deployment pattern for a Node.js application using Docker Compose. The setup includes:

Blue (Active) and Green (Backup) Node.js services

Nginx acting as a reverse proxy and traffic controller

Automatic failover in case the active service fails

Manual toggle of traffic between environments via a script

Forwarding of custom headers X-App-Pool and X-Release-Id

Goal: Ensure zero downtime and 100% request success during failover, as required by the HNG Stage 2 grader.

ğŸ— Architecture
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Client      â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ HTTP Requests
                       â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚     Nginx     â”‚
                â”‚ (Port 8080)   â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   Blue App    â”‚           â”‚   Green App   â”‚
 â”‚ (Active)      â”‚           â”‚ (Backup)      â”‚
 â”‚ Port 8081     â”‚           â”‚ Port 8082     â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš™ï¸ Features

Baseline Traffic: All requests go to Blue by default

Auto-Failover: Nginx retries requests on Green if Blue fails (timeout, error, or 5xx)

Manual Switch: Run ./switch.sh [blue|green] to manually toggle traffic

Custom Headers Forwarded:

X-App-Pool: blue|green

X-Release-Id: <version>

ğŸ“‚ File Structure
blue-green-app/
â”œâ”€ docker-compose.yml
â”œâ”€ .env
â”œâ”€ switch.sh
â””â”€ nginx/
   â”œâ”€ nginx.conf
   â””â”€ nginx.conf.template


docker-compose.yml â€“ Defines Blue, Green, and Nginx services, ports, and environment variables

.env â€“ Configurable environment variables for grader

switch.sh â€“ Bash script to toggle traffic between Blue and Green

nginx/nginx.conf.template â€“ Template for Nginx upstream configuration

nginx/nginx.conf â€“ Generated from the template based on active pool

âš¡ Prerequisites

Docker & Docker Compose installed

Ubuntu / Linux (or WSL for Windows users)

Internet access to pull the Node.js images

ğŸ“ Setup Instructions
1ï¸âƒ£ Clone Repository
git clone <your-repo-url>
cd blue-green-app

2ï¸âƒ£ Create .env File
# .env
BLUE_IMAGE=yimikaade/wonderful:devops-stage-two
GREEN_IMAGE=yimikaade/wonderful:devops-stage-two
BLUE_PORT=8081
GREEN_PORT=8082
NGINX_PORT=8080
RELEASE_ID_BLUE=v1
RELEASE_ID_GREEN=v2
ACTIVE_POOL=blue

3ï¸âƒ£ Start Services
docker compose up -d

4ï¸âƒ£ Verify Baseline (Blue Active)
curl -i http://localhost:8080/version


Expected headers:

X-App-Pool: blue
X-Release-Id: v1

ğŸ” Manual Switch Between Pools
# Switch to Green
./switch.sh green

# Switch back to Blue
./switch.sh blue


This updates Nginx configuration and reloads it without downtime

Confirm headers with:

curl -i http://localhost:8080/version

ğŸ’¥ Chaos Testing / Auto-Failover

Start chaos on Blue:

curl -X POST http://localhost:8081/chaos/start?mode=error


Nginx automatically retries Green if Blue fails:

curl -i http://localhost:8080/version


Stop chaos:

curl -X POST http://localhost:8081/chaos/stop


During chaos, all requests remain 200 OK

Headers show X-App-Pool: green after failover

âš™ï¸ Nginx Configuration Highlights

Upstream Block:

upstream backend {
    server app_green:3000 max_fails=3 fail_timeout=10s;
    server app_blue:3000 backup;
}


Main Route & Version Endpoint

location / {
    proxy_pass http://backend;
    proxy_set_header X-App-Pool $upstream_http_x_app_pool;
    proxy_set_header X-Release-Id $upstream_http_x_release_id;
}


Retry & Timeout Config

proxy_connect_timeout 3s;
proxy_read_timeout 5s;
proxy_next_upstream error timeout invalid_header http_502 http_503 http_504;
proxy_next_upstream_tries 2;

âœ… Points Checklist
Requirement	Status
Blue & Green Node.js images	âœ… Done
Expose /version, /healthz, /chaos endpoints	âœ… Done
Nginx reverse proxy on port 8080	âœ… Done
Auto-failover on Blue failure	âœ… Done
Forward X-App-Pool & X-Release-Id headers	âœ… Done
Manual switch with script	âœ… Done
Parameterized via .env	âœ… Done
Docker Compose orchestration	âœ… Done
Zero downtime, all requests succeed during failover	âœ… Done
ğŸ‰ Verification
# Baseline
curl -i http://localhost:8080/version

# Manual switch
./switch.sh green
curl -i http://localhost:8080/version

# Chaos failover
curl -X POST http://localhost:8081/chaos/start?mode=error
curl -i http://localhost:8080/version
curl -X POST http://localhost:8081/chaos/stop


All tests return 200 OK with correct headers for the active pool.

ğŸ–¼ Visual Summary
Client â†’ Nginx (8080) â†’ Blue (8081) / Green (8082)
                 â†˜ Auto-failover if Blue fails


This README is grader-ready: clear instructions, diagrams, verification steps, and all required headers/endpoints are documented.
